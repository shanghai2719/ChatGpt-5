workflows:
  macos_vps_247:
    name: "macOS M4 VPS Loop Runner"
    max_build_duration: 720  # tá»‘i Ä‘a 12h/láº§n build (Codemagic giá»›i háº¡n)
    instance_type: mac_mini_m4  # há»£p lá»‡ theo enum chÃ­nh thá»©c
    environment:
      vars:
        LOOP_FILE: "loop.py"
        PERSIST_PATH: "/Users/builder/.persist_data"
      xcode: latest
      # python khÃ´ng pháº£i field há»£p lá»‡ â€” dÃ¹ng shell Ä‘á»ƒ cÃ i Python thay tháº¿
    triggering:
      events:
        - push  # há»£p lá»‡; dÃ¹ng push thay cho manual
    scripts:
      - name: ðŸ§± Chuáº©n bá»‹ mÃ´i trÆ°á»ng
        script: |
          echo "=== CÃ i Python vÃ  setup mÃ´i trÆ°á»ng ==="
          brew install python@3.12 || echo "Python Ä‘Ã£ cÃ³ sáºµn"
          mkdir -p $PERSIST_PATH
          echo "LÆ°u data táº¡i: $PERSIST_PATH"

      - name: ðŸ Táº¡o file loop Python (cháº¡y ná»n 24/7)
        script: |
          cat > $LOOP_FILE <<'PYCODE'
          import os, time, datetime, json

          DATA_PATH = os.environ.get("PERSIST_PATH", "/Users/builder/.persist_data")
          LOG_FILE = os.path.join(DATA_PATH, "loop_log.json")

          print("ðŸŒ€ VPS Loop Runner khá»Ÿi Ä‘á»™ng...")

          while True:
              now = datetime.datetime.now().isoformat()
              print(f"[{now}] Há»‡ thá»‘ng hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh.")
              
              with open(LOG_FILE, "a") as f:
                  f.write(json.dumps({"time": now, "status": "running"}) + "\n")

              time.sleep(60)
          PYCODE

      - name: ðŸ” Giá»¯ tiáº¿n trÃ¬nh cháº¡y 24/7 (auto-restart)
        script: |
          echo "ðŸš€ Báº¯t Ä‘áº§u loop cháº¡y ná»n"
          while true; do
            python3 $LOOP_FILE || echo "âš ï¸ Loop dá»«ng â€” khá»Ÿi Ä‘á»™ng láº¡i sau 5s"
            sleep 5
          done
