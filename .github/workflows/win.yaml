name: MacOS 14.4 Test Lab QVNC

on: [workflow_dispatch]

jobs:
  rdp:
    runs-on: windows-2022
    steps:
      - name: Create user and enable RDP
        shell: powershell
        run: |
          # Táº¡o user
          net user blender 123456Hi /add
          net localgroup Administrators blender /add
          net localgroup "Remote Desktop Users" blender /add

          # Báº­t Remote Desktop
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Ensure OpenSSH Client
        shell: powershell
        run: |
          if (-not (Get-Command ssh -ErrorAction SilentlyContinue)) {
            Write-Output "Installing OpenSSH Client..."
            Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
          } else {
            Write-Output "OpenSSH Client already available."
          }

      - name: Start RDP Tunnel via Pinggy
        shell: bash
        run: |
          echo "ðŸš€ Starting SSH Tunnel..."
          ssh -p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 \
              -R0:localhost:3389 tcp@a.pinggy.io &
          TUNNEL_PID=$!
          echo "âœ… Tunnel running with PID $TUNNEL_PID"
          echo "âš¡ Wait ~5s, Pinggy will print the RDP URL below ðŸ‘‡"
          sleep 10

      - name: Keep alive (72h max)
        shell: bash
        run: |
          echo "ðŸ”’ Keeping workflow alive (72h limit)..."
          while true; do sleep 300; done
