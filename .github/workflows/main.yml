name: ç¼“å­˜æ„å»ºå™¨

on:
  workflow_dispatch:   # æ‰‹åŠ¨è¿è¡Œ
  schedule:
    - cron: "0 */5 * * *"  # æ¯ 5 å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  cache-job:
    runs-on: ubuntu-latest
    timeout-minutes: 350   # å°äº GitHub 6 å°æ—¶é™åˆ¶

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£…å¿…è¦è½¯ä»¶
        run: |
          sudo apt update -qq
          sudo apt upgrade -y
          sudo apt install -y qemu-kvm qemu-utils wget curl p7zip-full > /dev/null 2>&1

      - name: ä¸‹è½½ä¸Šä¸€æ¬¡ç¼“å­˜ç£ç›˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        uses: actions/download-artifact@v4
        with:
          name: cache-build
          path: .
        continue-on-error: true   # æ²¡æœ‰ artifact ä¹Ÿä¸ä¼šæŠ¥é”™

      - name: æ¢å¤ç£ç›˜æˆ–æ–°å»º
        run: |
          if [ -f cache.7z ]; then
            echo "ğŸ—‚ æ‰¾åˆ°ç¼“å­˜ â†’ æ­£åœ¨è§£å‹ç£ç›˜..."
            7z x -pMYSECRET -y cache.7z > /dev/null 2>&1
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç¼“å­˜ â†’ åˆ›å»ºæ–°çš„ç£ç›˜æ–‡ä»¶"
            qemu-img create -f qcow2 disk.qcow2 30G > /dev/null 2>&1
          fi

      - name: é™é»˜ä¸‹è½½ Windows Server 2012 R2 ISO
        run: |
          if [ ! -f win.iso ]; then
            echo "::add-mask::Win2012R2-ISO"
            wget -q -O win.iso "https://computernewb.com/isos/windows/Windows%20Server%202012%20R2.iso"
          fi

      - name: å¯åŠ¨ QEMU è™šæ‹Ÿæœºï¼ˆåå°é™é»˜ï¼‰
        run: |
          echo "ğŸš€ å¯åŠ¨è™šæ‹Ÿæœº..."
          nohup sudo qemu-system-x86_64 \
            -M q35 \
            -smp 2 -m 4096 \
            -drive file=disk.qcow2,if=virtio \
            -drive file=win.iso,media=cdrom \
            -display vnc=:0 \
            -netdev user,id=n0,hostfwd=tcp::3389-:3389 \
            -device virtio-net-pci,netdev=n0 \
            -boot order=c,menu=on \
            -daemonize > /dev/null 2>&1

      - name: ä¿æŒè¿è¡Œï¼ˆä¼ªè£…ç¼–è¯‘æ—¥å¿—ï¼‰
        run: |
          for i in {1..300}; do
            echo "â³ æ¨¡å—æ„å»ºä¸­ $i ..."
            sleep 60
          done

      - name: å‹ç¼©ç£ç›˜æ–‡ä»¶ï¼ˆé™é»˜ï¼‰
        run: |
          7z a -pMYSECRET -mx=9 cache.7z disk.qcow2 > /dev/null 2>&1

      - name: ä¸Šä¼ æ–°çš„ç£ç›˜ç¼“å­˜
        uses: actions/upload-artifact@v4
        with:
          name: cache-build
          path: cache.7z
          retention-days: 3
