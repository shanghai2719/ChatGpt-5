name: macOS VNC Runner

on:
  workflow_dispatch:

jobs:
  vnc-job:
    runs-on: macos-latest
    timeout-minutes: 350

    steps:
      - name: Enable VNC server (Screen Sharing)
        run: |
          # Bật Remote Management (Apple VNC)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -restart -agent -privs -all

          # Đặt mật khẩu cho VNC (Apple VNC chỉ nhận 8 ký tự đầu tiên)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -setvncpw 1

          echo "✅ 已启用 VNC: user=runner, pass=1"

      - name: Open reverse SSH tunnel (Pinggy, show URL)
        run: |
          while true; do
            ssh -p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 \
              -R0:localhost:5900 tcp@a.pinggy.io || true
            sleep 20
          done &

      - name: Keep alive
        run: |
          for i in {1..300}; do
            echo "⏳ Runner alive step $i ..."
            sleep 60
          done
